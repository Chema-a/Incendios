<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KAUIL</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ url_for('static',filename='styles/style.css') }}"
    />
  </head>
  <body>
    <div
      id="buttons-container"
      style="
        top: 0;
        left: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      "
    >
      <h2 style="color: white; margin-bottom: 580px">Kauil</h2>
      <button class="btn" id="loadWildfires">Cargar Incendios</button><br />
      <button class="btn" id="loadDataAndShowPredictions" disabled>
        Calcular índices de propagación</button
      ><br />
      <button class="btn" id="Predictions" disabled>
        Calcular predicción de propagación</button
      ><br />

      <div id="dialog" class="dialog">
        <div class="dialog-content">
          <span id="dialog-text">Hola</span>
        </div>
      </div>
    </div>
    <footer style="text-align: left"><h3></h3></footer>

    <div style="display: none" id="overlay"></div>
    <div id="map"></div>
    <div style="display: none" id="loader"></div>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.0/chroma.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
            var i = 0;
    function loading() {
            // Mostrar el overlay
            document.getElementById("overlay").style.display = "block";
            // Mostrar el loader
            document.getElementById("loader").style.display = "block";

            // Deshabilitar los botones durante la carga
            document.getElementById("loadWildfires").disabled = true;
            document.getElementById("loadDataAndShowPredictions").disabled = true;
        }

    function content_loaded() {
            // Ocultar el overlay
            document.getElementById("overlay").style.display = "none";
            // Ocultar el loader
            document.getElementById("loader").style.display = "none";

            // Habilitar los botones después de la carga
            document.getElementById("loadWildfires").disabled = false;
            document.getElementById("loadDataAndShowPredictions").disabled = false;
        }

    function CleanMap() {

        // Limpiar todas las capas del mapa
        map.eachLayer(function (layer) {
          map.removeLayer(layer);
        });

        // Volver a agregar la capa de mapa base
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
        }).addTo(map);
      }
      
      var map = L.map("map").setView([20.635, -103.57], 12);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      var loadWildfiresButton = document.getElementById("loadWildfires");
      var loadDataAndShowPredictionsButton = document.getElementById(
        "loadDataAndShowPredictions"
      );

      loadWildfiresButton.addEventListener("click", function () {
        CleanMap();
        loading();
        // Enviar una solicitud al servidor para cargar los incendios en el mapa
        $.ajax({
          url: "/kauil/load_wildfires",
          method: "GET",
          beforeSend: function () {
            loading(); // Mostrar el loader antes de la solicitud
          },
          complete: function () {
            content_loaded(); // Ocultar el loader cuando la solicitud se completa
          },
          success: function (heatPoints) {
            // Agrega los puntos al mapa existente
            // Define el icono personalizado
            var customIcon = L.icon({
                iconUrl: "{{ url_for('static',filename='images/fire.png') }}",
                iconSize: [40, 41],
                iconAnchor: [25, 41],
                popupAnchor: [1, -34],
            });

            heatPoints.forEach(function (point) {
                L.marker([point[1], point[0]],  { icon: customIcon }).addTo(map); // Agrega un marcador en la posición
            });
            
            document.getElementById(
              "loadDataAndShowPredictions"
            ).disabled = false;
        },
        });
      });

      loadDataAndShowPredictionsButton.addEventListener("click", function () {
        
        loading();
        dialog.style.display = "block";
        dialogText.innerText =
          "El modelo de Rothermel es un modelo matemático que predice la tasa de propagación de un incendio aplicado a un amplio rango de terreno forestal";
        $.ajax({
          url: "/kauil/load_DataAndShowSpreadRate",
          method: "GET",
          beforeSend: function () {
            loading(); // Mostrar el loader antes de la solicitud
          },
          complete: function () {
            content_loaded(); // Ocultar el loader cuando la solicitud se completa
          },
          success: function (response) {
            document.getElementById("Predictions").disabled = false;
            i++;

            if (i == 1) {
              // Define la leyenda estática
              var legend = L.control({ position: "bottomright" });

              legend.onAdd = function (map) {
                var div = L.DomUtil.create("div", "info legend");
                var labels = [
                  '<strong style="background: white; display: block; padding: 5px;">Índice de Propagación</strong>',
                ];
                var colors = ["green", "yellow", "orange", "red"]; // Colores para cada nivel de intensidad

                // Etiquetas y colores correspondientes
                var intensityLabels = ["Bajo", "Moderado", "Alto", "Muy Alto"];

                for (var i = 0; i < colors.length; i++) {
                  // Agregar un cuadro de color con fondo blanco
                  var colorBox =
                    '<span style="display: inline-block; width: 20px; height: 20px; background-color: white; border: 1px solid #ccc; background-clip: content-box;"><span style="display: inline-block; width: 100%; height: 100%; background-color: ' +
                    colors[i] +
                    ';"></span></span>';
                  div.innerHTML += colorBox + " " + intensityLabels[i] + "<br>";
                }

                div.innerHTML = labels.join("<br>") + div.innerHTML;
                return div;
              };

              // Agrega la leyenda al mapa
              legend.addTo(map);
            }
            // Obtén los valores mínimo y máximo del índice de propagación desde 'response'
            var minIntensity = Number.MAX_VALUE;
            var maxIntensity = Number.MIN_VALUE;

            response.features.forEach(function (feature) {
                var intensity = feature.properties.I;
                minIntensity = Math.min(minIntensity, intensity);
                maxIntensity = Math.max(maxIntensity, intensity);
            });

            // Define los colores que deseas usar en el gradiente
            var colors = ['green', 'yellow', 'orange', 'red'];

            // Crea una escala de colores personalizada utilizando chroma.js
            var colorScale = chroma.scale(colors).domain([minIntensity, maxIntensity]);

            // Crea una función para asignar colores en función del valor del índice de propagación
            function getColor(intensity) {
                return colorScale(intensity).hex();
            }
            // Recorre los features y agrega un círculo en cada ubicación con el color correspondiente
            response.features.forEach(function (feature) {
                var coordinates = feature.geometry.coordinates;
                var intensity = parseFloat(feature.properties.I);
                var color = getColor(intensity);

                // Crea un círculo en la ubicación con el color y radio adecuados
                circle = L.circle([coordinates[1], coordinates[0]], {
                    color: 'black',
                    weight: 1,
                    fillColor: color,
                    fillOpacity: 0.7,
                    radius: 400  
                }).addTo(map);
                    // Agrega un evento de clic al círculo para mostrar el tooltip
                circle.on('click', function (e) {
                    var tooltipContent = 
                        'Temperatura: ' + feature.properties.temperature + '<br>' +
                        'Velocidad del Viento: ' + feature.properties.wind_speed + '<br>' + 
                        'Carga de Combustible : ' + feature.properties.fuel_depth + '<br>' + 
                        'Profundidad de Combustible: ' + feature.properties.fuel_load + '<br>' + 
                        'Humedad de Combustible: ' + feature.properties.fuel_moisture + '<br>' ;

                    // Abre el tooltip en la ubicación del clic
                    circle.bindTooltip(tooltipContent).openTooltip(e.latlng);
                });  
            });  
          },  
        });
        
      });
    
     // Obtén elementos del DOM
     const PredictionsButton = document.getElementById("Predictions");
      const dialog = document.getElementById("dialog");
      const dialogText = document.getElementById("dialog-text");

      var customIconYellow = L.icon({
                iconUrl: "{{ url_for('static',filename='images/fire_yellow.png') }}",
                iconSize: [40, 41],
                iconAnchor: [25, 41],
                popupAnchor: [1, -34],
            });
        // Función para agregar un marcador al mapa
        function agregarMarcador(lat, lon) {
          L.marker([lat, lon],{icon: customIconYellow}).addTo(map);
        }

      // Mostrar el cuadro de diálogo al hacer clic en el botón
      PredictionsButton.addEventListener("click", () => {
        $.ajax({
          url: "/kauil/predict",
          method: "GET",
          beforeSend: function () {
            loading(); // Mostrar el loader antes de la solicitud
          },
          complete: function () {
            content_loaded(); // Ocultar el loader cuando la solicitud se completa
          },
          success: function (data) {
            for (var i = 0; i < data.length; i++) {
            var prediction = data[i];
            var latitud = prediction[0]; // Latitud predicha
            var longitud = prediction[1]; // Longitud predicha
            agregarMarcador(latitud, longitud); // Agrega el marcador al mapa
        }
          },
        });
      });
    
    </script>
  </body>
</html>
