<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de la Primavera</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/style.css') }}">
  </head>
  <body>
    <div id="buttons-container">
      <button class="btn" id="loadWildfires">Cargar Incendios</button>
      <button class="btn" id="loadDataAndShowPredictions">Indices de propagación</button>
    </div>
    <div style="display: none;" id="overlay"></div>
    <div id="map"></div>
    <div style="display: none;" id="loader"></div>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.0/chroma.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
    function loading() {
            // Mostrar el overlay
            document.getElementById("overlay").style.display = "block";
            // Mostrar el loader
            document.getElementById("loader").style.display = "block";

            // Deshabilitar los botones durante la carga
            document.getElementById("loadWildfires").disabled = true;
            document.getElementById("loadDataAndShowPredictions").disabled = true;
        }

    function content_loaded() {
            // Ocultar el overlay
            document.getElementById("overlay").style.display = "none";
            // Ocultar el loader
            document.getElementById("loader").style.display = "none";

            // Habilitar los botones después de la carga
            document.getElementById("loadWildfires").disabled = false;
            document.getElementById("loadDataAndShowPredictions").disabled = false;
        }

    function CleanMap() {
        // Limpiar todas las capas del mapa
        map.eachLayer(function (layer) {
          map.removeLayer(layer);
        });

        // Volver a agregar la capa de mapa base
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
        }).addTo(map);
      }
      var map = L.map("map").setView([20.635, -103.57], 12);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      var loadWildfiresButton = document.getElementById("loadWildfires");
      var loadDataAndShowPredictionsButton = document.getElementById(
        "loadDataAndShowPredictions"
      );

      loadWildfiresButton.addEventListener("click", function () {
        CleanMap();
        loading();
        // Enviar una solicitud al servidor para cargar los incendios en el mapa
        $.ajax({
          url: "/kauil/load_wildfires",
          method: "GET",
          beforeSend: function () {
            loading(); // Mostrar el loader antes de la solicitud
          },
          complete: function () {
            content_loaded(); // Ocultar el loader cuando la solicitud se completa
          },
          success: function (heatPoints) {
            console.log(heatPoints);
            // Agrega los puntos al mapa existente
            heatPoints.forEach(function (point) {
                L.marker([point[1], point[0]]).addTo(map); // Agrega un marcador en la posición
            });
        },
        });
      });

      loadDataAndShowPredictionsButton.addEventListener("click", function () {
        loading();
        $.ajax({
          url: "/kauil/load_DataAndShowSpreadRate",
          method: "GET",
          beforeSend: function () {
            loading(); // Mostrar el loader antes de la solicitud
          },
          complete: function () {
            content_loaded(); // Ocultar el loader cuando la solicitud se completa
          },
          success: function (response) {
              
// Obtén los valores mínimo y máximo del índice de propagación desde 'response'
var minIntensity = Number.MAX_VALUE;
var maxIntensity = Number.MIN_VALUE;

response.features.forEach(function (feature) {
    var intensity = feature.properties.I;
    minIntensity = Math.min(minIntensity, intensity);
    maxIntensity = Math.max(maxIntensity, intensity);
});

// Define los colores que deseas usar en el gradiente
var colors = ['green', 'yellow', 'orange', 'red'];

// Crea una escala de colores personalizada utilizando chroma.js
var colorScale = chroma.scale(colors).domain([minIntensity, maxIntensity]);

// Crea una función para asignar colores en función del valor del índice de propagación
function getColor(intensity) {
    return colorScale(intensity).hex();
}

// Recorre los features y agrega un círculo en cada ubicación con el color correspondiente
response.features.forEach(function (feature) {
    var coordinates = feature.geometry.coordinates;
    var intensity = feature.properties.I;
    var color = getColor(intensity);

    // Crea un círculo en la ubicación con el color y radio adecuados
    L.circle([coordinates[1], coordinates[0]], {
        color: 'black',
        weight: 1,
        fillColor: color,
        fillOpacity: 0.7,
        radius: 400  // Ajusta el radio según tus necesidades
    }).addTo(map);  // Asume que 'map' es tu objeto Leaflet
});
                
          },  
        });
      });
    </script>
  </body>
</html>
